name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'ml/**'
      - 'k8s/**'
      - '.github/workflows/**'

env:
  DOCKER_USERNAME: bernardoam04
  REGISTRY: docker.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Generate image tag
        id: tag
        run: |
          # Use git SHA for traceability
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image tag: ${SHORT_SHA}"

      - name: Build and push ML image
        uses: docker/build-push-action@v5
        with:
          context: ./ml
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/playlist-recommender-ml:${{ steps.tag.outputs.short_sha }}
            ${{ env.DOCKER_USERNAME }}/playlist-recommender-ml:latest
          cache-from: type=registry,ref=${{ env.DOCKER_USERNAME }}/playlist-recommender-ml:latest
          cache-to: type=inline

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/playlist-recommender-api:${{ steps.tag.outputs.short_sha }}
            ${{ env.DOCKER_USERNAME }}/playlist-recommender-api:latest
          cache-from: type=registry,ref=${{ env.DOCKER_USERNAME }}/playlist-recommender-api:latest
          cache-to: type=inline

      - name: Update Kubernetes manifests
        run: |
          SHORT_SHA="${{ steps.tag.outputs.short_sha }}"

          # Update ML job image tag
          sed -i "s|image: bernardoam04/playlist-recommender-ml:.*|image: bernardoam04/playlist-recommender-ml:${SHORT_SHA}|g" k8s/ml-job.yaml

          # Update API deployment image tag
          sed -i "s|image: bernardoam04/playlist-recommender-api:.*|image: bernardoam04/playlist-recommender-api:${SHORT_SHA}|g" k8s/deployment.yaml

          # Update SERVER_VERSION to match image tag
          sed -i "s|value: \".*\" # SERVER_VERSION|value: \"${SHORT_SHA}\" # SERVER_VERSION|g" k8s/deployment.yaml

          # Increment ML job version automatically
          CURRENT_JOB_NAME=$(grep "name: ml-job-" k8s/ml-job.yaml | head -1 | awk '{print $2}')
          echo "Current job name: ${CURRENT_JOB_NAME}"

          # Extract version number and increment
          if [[ $CURRENT_JOB_NAME =~ ml-job-ds([0-9]+)-v([0-9]+) ]]; then
            DS_NUM="${BASH_REMATCH[1]}"
            VERSION_NUM="${BASH_REMATCH[2]}"
            NEW_VERSION=$((VERSION_NUM + 1))
            NEW_JOB_NAME="ml-job-ds${DS_NUM}-v${NEW_VERSION}"
            sed -i "s|name: ${CURRENT_JOB_NAME}|name: ${NEW_JOB_NAME}|g" k8s/ml-job.yaml
            echo "Updated job name to: ${NEW_JOB_NAME}"
          fi

      - name: Commit and push updated manifests
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add k8s/ml-job.yaml k8s/deployment.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update image tags to ${{ steps.tag.outputs.short_sha }} [skip ci]"
            git push
          fi

      - name: ArgoCD sync notification
        run: |
          echo "âœ… Images built and pushed successfully!"
          echo "ðŸ“¦ ML Image: bernardoam04/playlist-recommender-ml:${{ steps.tag.outputs.short_sha }}"
          echo "ðŸ“¦ API Image: bernardoam04/playlist-recommender-api:${{ steps.tag.outputs.short_sha }}"
          echo "ðŸ”„ ArgoCD will auto-sync within 3 minutes"
          echo ""
          echo "To manually sync: argocd app sync bernardomiranda-playlist-recommender"
